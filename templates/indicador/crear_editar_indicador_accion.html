{% extends 'layout/base.html' %}
{% load static i18n %}
{% block css_vendor %}
{% endblock %}
{% block breadcumb %}
    {% include 'layout/breadcumbs.html' %}
{% endblock %}
{% block content %}
    <div class="d-flex flex-column flex-row-fluid gap-7 gap-lg-10">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="tab-content mt-3">
                <div class="d-flex flex-column gap-7 gap-lg-10">
                    <div class="card card-flush py-4">
                        <div class="card-header">
                            <div class="card-title">
                                <h2>Nuevo indicador</h2>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="mb-5 fv-plugins-icon-container">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex gap-5">
                                            <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                                <label class="form-label">{{ form.tipo_indicador.label }}</label>
                                                <div class="row row-cols-2 row-cols-md-10 g-5">
                                                    {% for ti in tipo_indicador %}
                                                        <div class="col">
                                                            <input type="radio" class="btn-check" name="tipo_indicador"
                                                                   value="{{ ti.id }}"
                                                                   id="{{ ti.id }}"
                                                                    {% if selected_tipo_indicador == ti %}
                                                                   checked="checked"
                                                                   {% elif forloop.first %}checked="checked"{% endif %}>
                                                            <label class="btn btn-outline btn-outline-dashed btn-active-light-primary d-flex justify-content-between  gap-5"
                                                                   for="{{ ti.id }}">
                                                                <div class="fs-5 fw-bold">{{ ti.nombre }}</div>

                                                                <i class="ki-duotone ki-information fs-2x"
                                                                   data-bs-toggle="tooltip"
                                                                   data-bs-placement="top"
                                                                   {% if ti.info_tooltip %}title="{{ ti.info_tooltip }}"
                                                                       >{% endif %}
                                                                   <i class="path1"></i>
                                                                   <i class="path2"></i>
                                                                   <i class="path3"></i>
                                                                </i>
                                                            </label>

                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>

                                        </div>
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.nombre.label }}</label>
                                            {{ form.nombre }}
                                            <div class="text-muted text-danger fs-7">{{ form.monto.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.descripcion.label }}</label>
                                            {{ form.descripcion }}
                                            <div class="text-muted text-danger fs-7">{{ form.descripcion.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.fuente_indicador.label }}</label>
                                            {{ form.fuente_indicador }}
                                            <div class="text-muted text-danger fs-7">{{ form.fuente_indicador.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.enfoqueIPCC.label }}</label>
                                            {{ form.enfoqueIPCC }}
                                            <div class="text-muted text-danger fs-7">{{ form.enfoqueIPCC.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.objetivos_relacionados.label }}</label>
                                            {{ form.objetivos_relacionados }}
                                            <div class="text-muted text-danger fs-7">{{ form.objetivos_relacionados.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">

                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.formula.label }}</label>
                                            {{ form.formula }}
                                            <div class="text-muted fs-7">{{ form.formula.help_text }}</div>
                                            <div class="text-muted text-danger fs-7">{{ form.formula.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">

                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.unidad_medida.label }}</label>
                                            {{ form.unidad_medida }}
                                            <div class="text-muted text-danger fs-7">{{ form.unidad_medida.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.frecuencia_medicion.label }}</label>
                                            {{ form.frecuencia_medicion }}
                                            <div class="text-muted text-danger fs-7">{{ form.frecuencia_medicion.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.direccion_optima.label }}</label>
                                            {{ form.direccion_optima }}
                                            <div class="text-muted fs-7">{{ form.direccion_optima.help_text }}</div>
                                            <div class="text-muted text-danger fs-7">{{ form.direccion_optima.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.meta_valor.label }}</label>
                                            {{ form.meta_valor }}
                                            <div class="text-muted fs-7">{{ form.meta_valor.help_text }}</div>
                                            <div class="text-muted text-danger fs-7">{{ form.meta_valor.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.meta_fecha_limite.label }}</label>
                                            <div class="position-relative d-flex align-items-center w-100">
                                                <input class="form-control fw-bold pe-5 flatpickr-input" required
                                                       placeholder="Fecha" name="meta_fecha_limite"
                                                       {% if indicador.meta_fecha_limite %}value="{{ indicador.meta_fecha_limite }}"{% endif %}
                                                       id="kt_fecha_flatpickr"/>
                                                <!--end::Datepicker-->
                                                <!--begin::Icon-->
                                                <i class="ki-duotone ki-calendar fs-4 position-absolute ms-4 end-0 me-2">
                                                    <div class="path1"></div>
                                                    <div class="path2"></div>
                                                </i>
                                            </div>
                                            <div class="text-danger fs-7">{{ form.meta_fecha_limite.errors }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-10 fv-row fv-plugins-icon-container w-100">
                                            <label class="form-label">{{ form.valor_baseline.label }}</label>
                                            {{ form.valor_baseline }}
                                            <div class="text-muted fs-7">{{ form.valor_baseline.help_text }}</div>
                                            <div class="text-muted text-danger fs-7">{{ form.valor_baseline.errors }}</div>
                                        </div>
                                    </div>

                                    <div class="mb-5">
                                        <h2>Variables</h2>
                                    </div>

                                    <!--begin::Repeater-->
                                    <div id="kt_docs_repeater_basic">
                                        <!--begin::Form group-->
                                        <div class="form-group">
                                            <div data-repeater-list="kt_docs_repeater_basic">
                                                {% if formset %}
                                                    {{ formset.management_form }}
                                                    {% for f in formset %}
                                                        <div data-repeater-item id="repeat_variable_indicador">
                                                            <div class="form-group row">
                                                                <div class="col-md-5">
                                                                    <div class="mb-2 fv-row fv-plugins-icon-container w-100">
                                                                        <label class="form-label">{{ f.nombre.label }}</label>
                                                                        {{ f.nombre }}
                                                                        <div class="text-muted text-danger fs-7">{{ f.nombre.errors }}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-5">
                                                                    <div class="mb-2 fv-row fv-plugins-icon-container w-100">
                                                                        <label class="form-label">{{ f.variable.label }}</label>
                                                                        {{ f.variable }}
                                                                        <div class="text-muted text-danger fs-7">{{ f.variable.errors }}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2 text-center">
                                                                    <a href="javascript:;" data-repeater-delete
                                                                       class="btn btn-sm btn-light-danger mt-3 mt-md-8">
                                                                        <i class="ki-duotone ki-trash fs-5"><span
                                                                                class="path1"></span><span
                                                                                class="path2"></span><span
                                                                                class="path3"></span><span
                                                                                class="path4"></span><span
                                                                                class="path5"></span></i>
                                                                        Eliminar
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div data-repeater-item id="repeat_variable_indicador">
                                                        <div class="form-group row">
                                                            <div class="col-md-5">
                                                                <div class="mb-2 fv-row fv-plugins-icon-container w-100">
                                                                    <label class="form-label">{{ form_variable_indicador.nombre.label }}</label>
                                                                    {{ form_variable_indicador.nombre }}
                                                                    <div class="text-muted text-danger fs-7">{{ form_variable_indicador.nombre.errors }}</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-5">
                                                                <div class="mb-2 fv-row fv-plugins-icon-container w-100">
                                                                    <label class="form-label">{{ form_variable_indicador.variable.label }}</label>

                                                                    {{ form_variable_indicador.variable }}
                                                                    <div class="text-muted text-danger fs-7">{{ form_variable_indicador.variable.errors }}</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-2 text-center">
                                                                <a href="javascript:;" data-repeater-delete
                                                                   class="btn btn-sm btn-light-danger mt-3 mt-md-8">
                                                                    <i class="ki-duotone ki-trash fs-5"><span
                                                                            class="path1"></span><span
                                                                            class="path2"></span><span
                                                                            class="path3"></span><span
                                                                            class="path4"></span><span
                                                                            class="path5"></span></i>
                                                                    Eliminar
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>

                                                {% endif %}
                                            </div>
                                            <div class="form-group align-center">
                                                <a href="javascript:;" data-repeater-create
                                                   class="btn btn-light-primary">
                                                    <i class="ki-duotone ki-plus fs-3"></i>
                                                    Agregar
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end::Repeater-->
                                    <input type="hidden" id="form_variables" name="form_variables" value="">
                                    <input type="hidden" id="formset_variables" name="formset_variables" value="">
                                </div>
                            </div>
                            <div class="d-flex justify-content-center mt-3">

                                <a href="{{ url_cancel }}" class="btn btn-light me-5">Atras</a>
                                <button type="submit" class="btn btn-primary">
                                    <span class="indicator-label">Guardar</span>
                                    <span class="indicator-progress">Please wait...
											<span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
                                </button>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}
{% block js %}
    <script src="{% static 'assets/plugins/custom/formrepeater/formrepeater.bundle.js' %}"></script>
    <script>
        $(function () {
            $('#kt_docs_repeater_basic').repeater({
                initEmpty: false,

                defaultValues: {
                    'text-input': 'foo'
                },

                show: function () {
                    $(this).slideDown();
                    // Re-init select2
                    $(this).find('[data-kt-repeater="select2"]').select2();
                },

                hide: function (deleteElement) {
                    $(this).slideUp(deleteElement);
                },
                ready: function () {
                    // Init select2
                    $('[data-kt-repeater="select2"]').select2();
                }
            });

            const form_variable = []
            const formset_variable = []
            $('form').on('submit', function () {
                // Limpiar arrays
                form_variable.length = 0;
                formset_variable.length = 0;

                // Obtener todos los elementos del repeater
                $('[data-repeater-item]').each(function () {
                    const $item = $(this);
                    const variable = {
                        nombre: '',
                        variable: '',
                    }

                    {% if formset %}
                        // Buscar cualquier input que contenga "nombre" en el name
                        const nombreInput = $item.find('input[name*="nombre"], select[name*="nombre"], textarea[name*="nombre"]').first();
                        const variableInput = $item.find('input[name*="variable"], select[name*="variable"], textarea[name*="variable"]').first();

                        variable.nombre = nombreInput.val() || '';
                        variable.variable = variableInput.val() || '';
                        formset_variable.push(variable);
                    {% else %}
                        variable.nombre = $item.find('#id_nombre').val() || '';
                        variable.variable = $item.find('#id_variable').val() || '';
                        form_variable.push(variable);
                    {% endif %}
                });

                $('#form_variables').val(JSON.stringify(form_variable));
                $('#formset_variables').val(JSON.stringify(formset_variable));

                console.log('Form variables:', form_variable);
                console.log('Formset variables:', formset_variable);
            })

            var defaultDate = '';


            {% if indicador.meta_fecha_limite %}
                defaultDate = "{{ indicador.meta_fecha_limite | date:'Y-m-d' }}";
            {% endif %}
            const locale_flatpickr = {
                firstDayOfWeek: 1,
                weekdays: {
                    shorthand: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                    longhand: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                },
                months: {
                    shorthand: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Оct', 'Nov', 'Dic'],
                    longhand: ['Enero', 'Febrero', 'Мarzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                },
            };
            const e = document.querySelector("#kt_fecha_flatpickr");
            n = $(e).flatpickr({
                altInput: !0,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: defaultDate,
                //onChange: function (e) {
                //   a(e, t, n)
                //{,
                locale: locale_flatpickr
            });
        })

    </script>
{% endblock %}